"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.default = createIoReducer;exports.normalizeToEntities = void 0;var _lodash = require("lodash");








var _normalizr = require("normalizr");
var _fieldsOperations = require("../lib/fieldsOperations");
var _stateOperations = require("./stateOperations");function _defineProperty(obj, key, value) {if (key in obj) {Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true });} else {obj[key] = value;}return obj;}







var normalizeToEntities = function normalizeToEntities(data, name, options) {
  var datasets = (0, _lodash.isArray)(data) ? data : [data];
  var entities = {};
  (0, _lodash.forEach)(datasets, function (dataset) {
    var normalisedData = (0, _normalizr.normalize)(dataset, options.schemas[name]);
    (0, _lodash.forEach)(normalisedData.entities, function (entity, name) {
      entities[name] = Object.assign({}, entities[name] || {}, entity);
    });
  });
  return entities;
};exports.normalizeToEntities = normalizeToEntities;

function createIoReducer(name) {var _Object$assign3;var customActions = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
  var actionName = (0, _lodash.toUpper)((0, _lodash.snakeCase)(name));
  var entityName = (0, _lodash.camelCase)(name);

  if (!options.schemas || !options.schemas[name])
  throw new Error('Missing normalize scheme');

  return Object.assign((_Object$assign3 = {}, _defineProperty(_Object$assign3, "FIND_".concat(
  actionName), function FIND_(state, action) {var
    uuid = action.uuid;
    var statuses = {
      isFinding: true,
      findError: null };

    var entities = _defineProperty({}, entityName, {});
    return (0, _stateOperations.updateState)(state, {
      statusUpdate: { statuses: statuses, entities: entities },
      uuid: uuid });

  }), _defineProperty(_Object$assign3, "FIND_".concat(

  actionName, "_FAILED"), function FIND__FAILED(state, action) {var
    uuid = action.uuid,error = action.error;
    var statuses = {
      isFinding: false };

    var entities = _defineProperty({}, entityName, {});
    return (0, _stateOperations.updateState)(state, {
      statusUpdate: { statuses: statuses, entities: entities },
      errorsUpdate: { uuid: uuid, error: error },
      uuid: uuid });

  }), _defineProperty(_Object$assign3, "FIND_".concat(

  actionName, "_COMPLETED"), function FIND__COMPLETED(state, action) {var
    uuid = action.uuid;
    var entities = normalizeToEntities(action.payload, entityName, options);
    var statuses = {
      init: true,
      isFinding: false };

    return (0, _stateOperations.upsertEntitiesToState)(state, { uuid: uuid, entities: entities, statuses: statuses });
  }), _defineProperty(_Object$assign3, "RECEIVE_".concat(

  actionName), function RECEIVE_(state, action) {var
    uuid = action.uuid;
    var entities = normalizeToEntities(action.data, name, options);
    return (0, _stateOperations.upsertEntitiesToState)(state, { uuid: uuid, entities: entities });
  }), _defineProperty(_Object$assign3, "REMOVE_".concat(

  actionName), function REMOVE_(state, action) {var
    uuid = action.uuid;
    var entities = normalizeToEntities(action.data, name, options);
    return (0, _stateOperations.removeEntitiesFromState)(state, { uuid: uuid, entities: entities, cache: false });
  }), _defineProperty(_Object$assign3, "CREATE_".concat(

  actionName), function CREATE_(state, action) {var
    uuid = action.uuid;
    var entities = normalizeToEntities(action.payload, entityName, options);
    var statuses = {
      isWriting: true };

    return (0, _stateOperations.addEntitiesToState)(state, { uuid: uuid, entities: entities, statuses: statuses, cache: true });
  }), _defineProperty(_Object$assign3, "CREATE_".concat(

  actionName, "_FAILED"), function CREATE__FAILED(state, action) {var
    uuid = action.uuid,error = action.error;
    var entities = state.actionCache[uuid];
    var statuses = {
      isWriting: false };

    return (0, _stateOperations.removeEntitiesFromState)(state, { uuid: uuid, entities: entities, statuses: statuses, error: error, cache: false });
  }), _defineProperty(_Object$assign3, "CREATE_".concat(

  actionName, "_COMPLETED"), function CREATE__COMPLETED(state, action) {
    // UPDATE _temp and ids
    var uuid = action.uuid;
    var statuses = {
      isWriting: false };

    var entities = _defineProperty({}, entityName, {});
    return (0, _stateOperations.updateState)(state, {
      statusUpdate: { statuses: statuses, entities: entities },
      cacheUpdate: { uuid: uuid },
      uuid: uuid });

  }), _defineProperty(_Object$assign3, "UPDATE_".concat(

  actionName), function UPDATE_(state, action) {var
    uuid = action.uuid;
    var entities = normalizeToEntities(action.payload, entityName, options);
    var statuses = {
      isWriting: true };

    return (0, _stateOperations.updateEntitiesInState)(state, { uuid: uuid, entities: entities, statuses: statuses, cache: true }, options);
  }), _defineProperty(_Object$assign3, "UPDATE_".concat(

  actionName, "_FAILED"), function UPDATE__FAILED(state, action) {var
    uuid = action.uuid,error = action.error;
    var entities = state.actionCache[uuid];
    var statuses = {
      isWriting: false };

    return (0, _stateOperations.updateEntitiesInState)(state, { uuid: uuid, entities: entities, statuses: statuses, error: error, cache: false }, options);
  }), _defineProperty(_Object$assign3, "UPDATE_".concat(

  actionName, "_COMPLETED"), function UPDATE__COMPLETED(state, action) {
    // UPDATE _temp and ids
    var uuid = action.uuid;
    var statuses = {
      isWriting: false };

    var entities = _defineProperty({}, entityName, {});
    return (0, _stateOperations.updateState)(state, {
      statusUpdate: { statuses: statuses, entities: entities },
      uuid: uuid });

  }), _defineProperty(_Object$assign3, "DESTROY_".concat(

  actionName), function DESTROY_(state, action) {var
    uuid = action.uuid;
    var entities = normalizeToEntities(action.payload, entityName, options);
    var statuses = {
      isWriting: true };

    return (0, _stateOperations.removeEntitiesFromState)(state, { uuid: uuid, entities: entities, statuses: statuses, cache: true });
  }), _defineProperty(_Object$assign3, "DESTROY_".concat(

  actionName, "_FAILED"), function DESTROY__FAILED(state, action) {var
    uuid = action.uuid,error = action.error;
    var entities = state.actionCache[uuid];
    var statuses = {
      isWriting: false };

    return (0, _stateOperations.addEntitiesToState)(state, { uuid: uuid, entities: entities, statuses: statuses, error: error, cache: false });
  }), _defineProperty(_Object$assign3, "DESTROY_".concat(

  actionName, "_COMPLETED"), function DESTROY__COMPLETED(state, action) {var
    uuid = action.uuid;
    var statuses = {
      isWriting: false };

    var entities = _defineProperty({}, entityName, {});
    return (0, _stateOperations.updateState)(state, {
      statusUpdate: { statuses: statuses, entities: entities },
      uuid: uuid });

  }), _defineProperty(_Object$assign3, "SELECT_".concat(

  actionName), function SELECT_(state, action) {var
    data = action.data;
    // Object workaround
    var key = (0, _lodash.isObject)(data) ? data[options.keyName] : data;
    var selected = (0, _lodash.isArray)(key) ? key : [key];
    var statuses = {
      selected: selected };

    var entities = _defineProperty({}, entityName, {});
    return (0, _stateOperations.updateState)(state, {
      statusUpdate: { statuses: statuses, entities: entities } });

  }), _defineProperty(_Object$assign3, "CLEAR_".concat(

  actionName), function CLEAR_(state) {
    return Object.assign({}, state, _defineProperty({},
    entityName, {}));

  }), _defineProperty(_Object$assign3, "RESET_".concat(

  actionName), function RESET_(state) {
    return Object.assign({}, state, _defineProperty({},
    entityName, {}));

  }), _Object$assign3),

  (0, _lodash.mapValues)(customActions, function (reducer) {return function (state, action) {
      var instanceState = Object.assign({}, state[name]);
      return Object.assign({}, state, _defineProperty({}, name, reducer(instanceState, action)));
    };}));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9yZWR1Y2Vycy9jcmVhdGVJb1JlZHVjZXJzLmpzIl0sIm5hbWVzIjpbIm5vcm1hbGl6ZVRvRW50aXRpZXMiLCJkYXRhIiwibmFtZSIsIm9wdGlvbnMiLCJkYXRhc2V0cyIsImVudGl0aWVzIiwiZGF0YXNldCIsIm5vcm1hbGlzZWREYXRhIiwic2NoZW1hcyIsImVudGl0eSIsIk9iamVjdCIsImFzc2lnbiIsImNyZWF0ZUlvUmVkdWNlciIsImN1c3RvbUFjdGlvbnMiLCJhY3Rpb25OYW1lIiwiZW50aXR5TmFtZSIsIkVycm9yIiwic3RhdGUiLCJhY3Rpb24iLCJ1dWlkIiwic3RhdHVzZXMiLCJpc0ZpbmRpbmciLCJmaW5kRXJyb3IiLCJzdGF0dXNVcGRhdGUiLCJlcnJvciIsImVycm9yc1VwZGF0ZSIsInBheWxvYWQiLCJpbml0IiwiY2FjaGUiLCJpc1dyaXRpbmciLCJhY3Rpb25DYWNoZSIsImNhY2hlVXBkYXRlIiwia2V5Iiwia2V5TmFtZSIsInNlbGVjdGVkIiwicmVkdWNlciIsImluc3RhbmNlU3RhdGUiXSwibWFwcGluZ3MiOiJrSkFBQTs7Ozs7Ozs7O0FBU0E7QUFDQTtBQUNBLG9EOzs7Ozs7OztBQVFPLElBQU1BLG1CQUFtQixHQUFHLFNBQXRCQSxtQkFBc0IsQ0FBQ0MsSUFBRCxFQUFPQyxJQUFQLEVBQWFDLE9BQWIsRUFBeUI7QUFDMUQsTUFBSUMsUUFBUSxHQUFHLHFCQUFRSCxJQUFSLElBQWdCQSxJQUFoQixHQUF1QixDQUFDQSxJQUFELENBQXRDO0FBQ0EsTUFBSUksUUFBUSxHQUFHLEVBQWY7QUFDQSx1QkFBUUQsUUFBUixFQUFrQixVQUFBRSxPQUFPLEVBQUk7QUFDM0IsUUFBSUMsY0FBYyxHQUFHLDBCQUFVRCxPQUFWLEVBQW1CSCxPQUFPLENBQUNLLE9BQVIsQ0FBZ0JOLElBQWhCLENBQW5CLENBQXJCO0FBQ0EseUJBQVFLLGNBQWMsQ0FBQ0YsUUFBdkIsRUFBaUMsVUFBQ0ksTUFBRCxFQUFTUCxJQUFULEVBQWtC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QUFaLEVBQW1CO0FBQ3hCTSxNQUFBQSxZQUFZLEVBQUUsRUFBRUgsUUFBUSxFQUFSQSxRQUFGLEVBQVlmLFFBQVEsRUFBUkEsUUFBWixFQURVLEVBQW5CLENBQVA7O0FBR0QsR0ExSkk7O0FBNEpLUyxFQUFBQSxVQTVKTCxtQkE0Sm1CRyxLQTVKbkIsRUE0SjBCO0FBQzdCLFdBQU9QLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JNLEtBQWxCO0FBQ0pGLElBQUFBLFVBREksRUFDUyxFQURULEVBQVA7O0FBR0QsR0FoS0k7O0FBa0tLRCxFQUFBQSxVQWxLTCxtQkFrS21CRyxLQWxLbkIsRUFrSzBCO0FBQzdCLFdBQU9QLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JNLEtBQWxCO0FBQ0pGLElBQUFBLFVBREksRUFDUyxFQURULEVBQVA7O0FBR0QsR0F0S0k7O0FBd0tQLHlCQUFVRixhQUFWLEVBQXlCLFVBQUFzQixPQUFPLFVBQUksVUFBQ2xCLEtBQUQsRUFBUUMsTUFBUixFQUFtQjtBQUNyRCxVQUFNa0IsYUFBYSxHQUFHMUIsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQk0sS0FBSyxDQUFDZixJQUFELENBQXZCLENBQXRCO0FBQ0EsYUFBT1EsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQk0sS0FBbEIsc0JBQTRCZixJQUE1QixFQUFtQ2lDLE9BQU8sQ0FBQ0MsYUFBRCxFQUFnQmxCLE1BQWhCLENBQTFDLEVBQVA7QUFDRCxLQUgrQixFQUFoQyxDQXhLTyxDQUFQO0FBNEtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICB0b1VwcGVyLFxyXG4gIHNuYWtlQ2FzZSxcclxuICBjYW1lbENhc2UsXHJcbiAgaXNBcnJheSxcclxuICBtYXBWYWx1ZXMsXHJcbiAgaXNPYmplY3QsXHJcbiAgZm9yRWFjaFxyXG59IGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB7IG5vcm1hbGl6ZSB9IGZyb20gJ25vcm1hbGl6cic7XHJcbmltcG9ydCB7IHBhcnNlTG9jYWxEYXRhIH0gZnJvbSAnLi4vbGliL2ZpZWxkc09wZXJhdGlvbnMnO1xyXG5pbXBvcnQge1xyXG4gIHVwZGF0ZVN0YXRlLFxyXG4gIHVwc2VydEVudGl0aWVzVG9TdGF0ZSxcclxuICBhZGRFbnRpdGllc1RvU3RhdGUsXHJcbiAgdXBkYXRlRW50aXRpZXNJblN0YXRlLFxyXG4gIHJlbW92ZUVudGl0aWVzRnJvbVN0YXRlXHJcbn0gZnJvbSAnLi9zdGF0ZU9wZXJhdGlvbnMnO1xyXG5cclxuZXhwb3J0IGNvbnN0IG5vcm1hbGl6ZVRvRW50aXRpZXMgPSAoZGF0YSwgbmFtZSwgb3B0aW9ucykgPT4ge1xyXG4gIGxldCBkYXRhc2V0cyA9IGlzQXJyYXkoZGF0YSkgPyBkYXRhIDogW2RhdGFdO1xyXG4gIGxldCBlbnRpdGllcyA9IHt9O1xyXG4gIGZvckVhY2goZGF0YXNldHMsIGRhdGFzZXQgPT4ge1xyXG4gICAgbGV0IG5vcm1hbGlzZWREYXRhID0gbm9ybWFsaXplKGRhdGFzZXQsIG9wdGlvbnMuc2NoZW1hc1tuYW1lXSk7XHJcbiAgICBmb3JFYWNoKG5vcm1hbGlzZWREYXRhLmVudGl0aWVzLCAoZW50aXR5LCBuYW1lKSA9PiB7XHJcbiAgICAgIGVudGl0aWVzW25hbWVdID0gT2JqZWN0LmFzc2lnbih7fSwgKGVudGl0aWVzW25hbWVdIHx8IHt9KSwgZW50aXR5KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG4gIHJldHVybiBlbnRpdGllcztcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZUlvUmVkdWNlcihuYW1lLCBjdXN0b21BY3Rpb25zID0ge30sIG9wdGlvbnMgPSB7fSkge1xyXG4gIGNvbnN0IGFjdGlvbk5hbWUgPSB0b1VwcGVyKHNuYWtlQ2FzZShuYW1lKSk7XHJcbiAgY29uc3QgZW50aXR5TmFtZSA9IGNhbWVsQ2FzZShuYW1lKTtcclxuXHJcbiAgaWYgKCFvcHRpb25zLnNjaGVtYXMgfHwgIW9wdGlvbnMuc2NoZW1hc1tuYW1lXSlcclxuICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBub3JtYWxpemUgc2NoZW1lJyk7XHJcblxyXG4gIHJldHVybiBPYmplY3QuYXNzaWduKHtcclxuICAgIFtgRklORF8ke2FjdGlvbk5hbWV9YF0oc3RhdGUsIGFjdGlvbikge1xyXG4gICAgICBjb25zdCB7IHV1aWQgfSA9IGFjdGlvbjtcclxuICAgICAgY29uc3Qgc3RhdHVzZXMgPSB7XHJcbiAgICAgICAgaXNGaW5kaW5nOiB0cnVlLFxyXG4gICAgICAgIGZpbmRFcnJvcjogbnVsbFxyXG4gICAgICB9O1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IHsgW2VudGl0eU5hbWVdOiB7fX07XHJcbiAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShzdGF0ZSwge1xyXG4gICAgICAgIHN0YXR1c1VwZGF0ZTogeyBzdGF0dXNlcywgZW50aXRpZXMgfSxcclxuICAgICAgICB1dWlkXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYEZJTkRfJHthY3Rpb25OYW1lfV9GQUlMRURgXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgdXVpZCwgZXJyb3IgfSA9IGFjdGlvbjtcclxuICAgICAgY29uc3Qgc3RhdHVzZXMgPSB7XHJcbiAgICAgICAgaXNGaW5kaW5nOiBmYWxzZVxyXG4gICAgICB9O1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IHsgW2VudGl0eU5hbWVdOiB7fX07XHJcbiAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShzdGF0ZSwge1xyXG4gICAgICAgIHN0YXR1c1VwZGF0ZTogeyBzdGF0dXNlcywgZW50aXRpZXMgfSxcclxuICAgICAgICBlcnJvcnNVcGRhdGU6IHsgdXVpZCwgZXJyb3IgfSxcclxuICAgICAgICB1dWlkXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYEZJTkRfJHthY3Rpb25OYW1lfV9DT01QTEVURURgXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgdXVpZCB9ID0gYWN0aW9uO1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IG5vcm1hbGl6ZVRvRW50aXRpZXMoYWN0aW9uLnBheWxvYWQsIGVudGl0eU5hbWUsIG9wdGlvbnMpO1xyXG4gICAgICBjb25zdCBzdGF0dXNlcyA9IHtcclxuICAgICAgICBpbml0OiB0cnVlLFxyXG4gICAgICAgIGlzRmluZGluZzogZmFsc2VcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIHVwc2VydEVudGl0aWVzVG9TdGF0ZShzdGF0ZSwgeyB1dWlkLCBlbnRpdGllcywgc3RhdHVzZXMgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIFtgUkVDRUlWRV8ke2FjdGlvbk5hbWV9YF0oc3RhdGUsIGFjdGlvbikge1xyXG4gICAgICBjb25zdCB7IHV1aWQgfSA9IGFjdGlvbjtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSBub3JtYWxpemVUb0VudGl0aWVzKGFjdGlvbi5kYXRhLCBuYW1lLCBvcHRpb25zKTtcclxuICAgICAgcmV0dXJuIHVwc2VydEVudGl0aWVzVG9TdGF0ZShzdGF0ZSwgeyB1dWlkLCBlbnRpdGllcyB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgW2BSRU1PVkVfJHthY3Rpb25OYW1lfWBdKHN0YXRlLCBhY3Rpb24pIHtcclxuICAgICAgY29uc3QgeyB1dWlkIH0gPSBhY3Rpb247XHJcbiAgICAgIGNvbnN0IGVudGl0aWVzID0gbm9ybWFsaXplVG9FbnRpdGllcyhhY3Rpb24uZGF0YSwgbmFtZSwgb3B0aW9ucyk7XHJcbiAgICAgIHJldHVybiByZW1vdmVFbnRpdGllc0Zyb21TdGF0ZShzdGF0ZSwgeyB1dWlkLCBlbnRpdGllcywgY2FjaGU6IGZhbHNlIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYENSRUFURV8ke2FjdGlvbk5hbWV9YF0oc3RhdGUsIGFjdGlvbikge1xyXG4gICAgICBjb25zdCB7IHV1aWQgfSA9IGFjdGlvbjtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSBub3JtYWxpemVUb0VudGl0aWVzKGFjdGlvbi5wYXlsb2FkLCBlbnRpdHlOYW1lLCBvcHRpb25zKTtcclxuICAgICAgY29uc3Qgc3RhdHVzZXMgPSB7XHJcbiAgICAgICAgaXNXcml0aW5nOiB0cnVlXHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiBhZGRFbnRpdGllc1RvU3RhdGUoc3RhdGUsIHsgdXVpZCwgZW50aXRpZXMsIHN0YXR1c2VzLCBjYWNoZTogdHJ1ZSB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgW2BDUkVBVEVfJHthY3Rpb25OYW1lfV9GQUlMRURgXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgdXVpZCwgZXJyb3IgfSA9IGFjdGlvbjtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSBzdGF0ZS5hY3Rpb25DYWNoZVt1dWlkXTtcclxuICAgICAgY29uc3Qgc3RhdHVzZXMgPSB7XHJcbiAgICAgICAgaXNXcml0aW5nOiBmYWxzZVxyXG4gICAgICB9O1xyXG4gICAgICByZXR1cm4gcmVtb3ZlRW50aXRpZXNGcm9tU3RhdGUoc3RhdGUsIHsgdXVpZCwgZW50aXRpZXMsIHN0YXR1c2VzLCBlcnJvciwgY2FjaGU6IGZhbHNlIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYENSRUFURV8ke2FjdGlvbk5hbWV9X0NPTVBMRVRFRGBdKHN0YXRlLCBhY3Rpb24pIHtcclxuICAgICAgLy8gVVBEQVRFIF90ZW1wIGFuZCBpZHNcclxuICAgICAgY29uc3QgeyB1dWlkIH0gPSBhY3Rpb247XHJcbiAgICAgIGNvbnN0IHN0YXR1c2VzID0ge1xyXG4gICAgICAgIGlzV3JpdGluZzogZmFsc2VcclxuICAgICAgfTtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSB7IFtlbnRpdHlOYW1lXToge319O1xyXG4gICAgICByZXR1cm4gdXBkYXRlU3RhdGUoc3RhdGUsIHtcclxuICAgICAgICBzdGF0dXNVcGRhdGU6IHsgc3RhdHVzZXMsIGVudGl0aWVzIH0sXHJcbiAgICAgICAgY2FjaGVVcGRhdGU6IHsgdXVpZCB9LFxyXG4gICAgICAgIHV1aWRcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIFtgVVBEQVRFXyR7YWN0aW9uTmFtZX1gXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgdXVpZCB9ID0gYWN0aW9uO1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IG5vcm1hbGl6ZVRvRW50aXRpZXMoYWN0aW9uLnBheWxvYWQsIGVudGl0eU5hbWUsIG9wdGlvbnMpO1xyXG4gICAgICBjb25zdCBzdGF0dXNlcyA9IHtcclxuICAgICAgICBpc1dyaXRpbmc6IHRydWVcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIHVwZGF0ZUVudGl0aWVzSW5TdGF0ZShzdGF0ZSwgeyB1dWlkLCBlbnRpdGllcywgc3RhdHVzZXMsIGNhY2hlOiB0cnVlIH0sIG9wdGlvbnMpO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYFVQREFURV8ke2FjdGlvbk5hbWV9X0ZBSUxFRGBdKHN0YXRlLCBhY3Rpb24pIHtcclxuICAgICAgY29uc3QgeyB1dWlkLCBlcnJvciB9ID0gYWN0aW9uO1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IHN0YXRlLmFjdGlvbkNhY2hlW3V1aWRdO1xyXG4gICAgICBjb25zdCBzdGF0dXNlcyA9IHtcclxuICAgICAgICBpc1dyaXRpbmc6IGZhbHNlXHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiB1cGRhdGVFbnRpdGllc0luU3RhdGUoc3RhdGUsIHsgdXVpZCwgZW50aXRpZXMsIHN0YXR1c2VzLCBlcnJvciwgY2FjaGU6IGZhbHNlIH0sIG9wdGlvbnMpO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYFVQREFURV8ke2FjdGlvbk5hbWV9X0NPTVBMRVRFRGBdKHN0YXRlLCBhY3Rpb24pIHtcclxuICAgICAgLy8gVVBEQVRFIF90ZW1wIGFuZCBpZHNcclxuICAgICAgY29uc3QgeyB1dWlkIH0gPSBhY3Rpb247XHJcbiAgICAgIGNvbnN0IHN0YXR1c2VzID0ge1xyXG4gICAgICAgIGlzV3JpdGluZzogZmFsc2VcclxuICAgICAgfTtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSB7IFtlbnRpdHlOYW1lXToge319O1xyXG4gICAgICByZXR1cm4gdXBkYXRlU3RhdGUoc3RhdGUsIHtcclxuICAgICAgICBzdGF0dXNVcGRhdGU6IHsgc3RhdHVzZXMsIGVudGl0aWVzIH0sXHJcbiAgICAgICAgdXVpZFxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgW2BERVNUUk9ZXyR7YWN0aW9uTmFtZX1gXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgdXVpZCB9ID0gYWN0aW9uO1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IG5vcm1hbGl6ZVRvRW50aXRpZXMoYWN0aW9uLnBheWxvYWQsIGVudGl0eU5hbWUsIG9wdGlvbnMpO1xyXG4gICAgICBjb25zdCBzdGF0dXNlcyA9IHtcclxuICAgICAgICBpc1dyaXRpbmc6IHRydWVcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIHJlbW92ZUVudGl0aWVzRnJvbVN0YXRlKHN0YXRlLCB7IHV1aWQsIGVudGl0aWVzLCBzdGF0dXNlcywgY2FjaGU6IHRydWUgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIFtgREVTVFJPWV8ke2FjdGlvbk5hbWV9X0ZBSUxFRGBdKHN0YXRlLCBhY3Rpb24pIHtcclxuICAgICAgY29uc3QgeyB1dWlkLCBlcnJvciB9ID0gYWN0aW9uO1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IHN0YXRlLmFjdGlvbkNhY2hlW3V1aWRdO1xyXG4gICAgICBjb25zdCBzdGF0dXNlcyA9IHtcclxuICAgICAgICBpc1dyaXRpbmc6IGZhbHNlXHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiBhZGRFbnRpdGllc1RvU3RhdGUoc3RhdGUsIHsgdXVpZCwgZW50aXRpZXMsIHN0YXR1c2VzLCBlcnJvciwgY2FjaGU6IGZhbHNlIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBbYERFU1RST1lfJHthY3Rpb25OYW1lfV9DT01QTEVURURgXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgdXVpZCB9ID0gYWN0aW9uO1xyXG4gICAgICBjb25zdCBzdGF0dXNlcyA9IHtcclxuICAgICAgICBpc1dyaXRpbmc6IGZhbHNlXHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IGVudGl0aWVzID0geyBbZW50aXR5TmFtZV06IHt9fTtcclxuICAgICAgcmV0dXJuIHVwZGF0ZVN0YXRlKHN0YXRlLCB7XHJcbiAgICAgICAgc3RhdHVzVXBkYXRlOiB7IHN0YXR1c2VzLCBlbnRpdGllcyB9LFxyXG4gICAgICAgIHV1aWRcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIFtgU0VMRUNUXyR7YWN0aW9uTmFtZX1gXShzdGF0ZSwgYWN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYWN0aW9uO1xyXG4gICAgICAvLyBPYmplY3Qgd29ya2Fyb3VuZFxyXG4gICAgICBsZXQga2V5ID0gaXNPYmplY3QoZGF0YSkgPyBkYXRhW29wdGlvbnMua2V5TmFtZV0gOiBkYXRhO1xyXG4gICAgICBsZXQgc2VsZWN0ZWQgPSBpc0FycmF5KGtleSkgPyBrZXkgOiBba2V5XTtcclxuICAgICAgY29uc3Qgc3RhdHVzZXMgPSB7XHJcbiAgICAgICAgc2VsZWN0ZWRcclxuICAgICAgfTtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSB7IFtlbnRpdHlOYW1lXToge319O1xyXG4gICAgICByZXR1cm4gdXBkYXRlU3RhdGUoc3RhdGUsIHtcclxuICAgICAgICBzdGF0dXNVcGRhdGU6IHsgc3RhdHVzZXMsIGVudGl0aWVzIH1cclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIFtgQ0xFQVJfJHthY3Rpb25OYW1lfWBdKHN0YXRlKSB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSwge1xyXG4gICAgICAgIFtlbnRpdHlOYW1lXToge31cclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIFtgUkVTRVRfJHthY3Rpb25OYW1lfWBdKHN0YXRlKSB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSwge1xyXG4gICAgICAgIFtlbnRpdHlOYW1lXToge31cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBtYXBWYWx1ZXMoY3VzdG9tQWN0aW9ucywgcmVkdWNlciA9PiAoc3RhdGUsIGFjdGlvbikgPT4ge1xyXG4gICAgY29uc3QgaW5zdGFuY2VTdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXRlW25hbWVdKTtcclxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSwgeyBbbmFtZV06IHJlZHVjZXIoaW5zdGFuY2VTdGF0ZSwgYWN0aW9uKSB9KTtcclxuICB9KSk7XHJcbn0iXX0=